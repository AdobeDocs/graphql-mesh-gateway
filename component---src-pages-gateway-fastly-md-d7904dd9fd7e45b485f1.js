"use strict";(self.webpackChunkgraphql_mesh_gateway=self.webpackChunkgraphql_mesh_gateway||[]).push([[4921],{21209:function(e,a,n){n.r(a),n.d(a,{_frontmatter:function(){return d},default:function(){return h}});var t=n(87462),r=n(45987),m=(n(35776),n(3905)),p=n(91515);const i=["components"],d={},s=(o="InlineAlert",function(e){return console.warn("Component "+o+" was not imported, exported, or provided by MDXProvider as global scope"),(0,m.mdx)("div",e)});var o;const l={_frontmatter:d},c=p.Z;function h(e){let{components:a}=e,n=(0,r.Z)(e,i);return(0,m.mdx)(c,(0,t.Z)({},l,n,{components:a,mdxType:"MDXLayout"}),(0,m.mdx)("h1",{id:"dynamic-cache-control-with-fastly"},"Dynamic cache control with Fastly"),(0,m.mdx)("p",null,"Adding a content delivery network (CDN) for caching dynamic content with API Mesh for Adobe Developer App Builder provides additional security and improved performance. Follow these instructions to integrate API Mesh, Adobe Commerce, and ",(0,m.mdx)("a",{parentName:"p",href:"https://experienceleague.adobe.com/docs/commerce-cloud-service/user-guide/cdn/fastly.html?lang=en"},"Fastly")," (provided with Adobe Commerce Pro accounts)."),(0,m.mdx)("h2",{id:"configure-headers-in-api-mesh"},"Configure headers in API Mesh"),(0,m.mdx)(s,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,m.mdx)("p",null,"After adding VCL snippets in the ",(0,m.mdx)("a",{parentName:"p",href:"#configure-fastly-in-adobe-commerce"},"Fastly Setup"),", your Commerce GraphQL URL is now in the following format with no ",(0,m.mdx)("inlineCode",{parentName:"p"},"api_key")," appended: ",(0,m.mdx)("inlineCode",{parentName:"p"},"https://graph.adobe.io/api/<meshId>/graphql")),(0,m.mdx)("p",null,"To distinguish between requests from users and requests from API Mesh, use the following source operation header to prevent Fastly from caching headers that come directly from API Mesh:"),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-json"},'"x-commerce-bypass-fastly-cache": "true" \n')),(0,m.mdx)("p",null,"When bypassing the cache, you must also specify which headers should be preserved in the ",(0,m.mdx)("inlineCode",{parentName:"p"},"responseConfig"),":"),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-json"},'"responseConfig": {\n  "headers": [\n    "x-magento-cache-id",\n    "x-magento-tags",\n    "set-cookie",\n    "pragma",\n    "cache-control",\n    "expires",\n    "x-content-type-options",\n    "x-xss-protection",\n    "x-platform-server"\n  ]\n}\n')),(0,m.mdx)("p",null,"Using Fastly also requires all queries to be ",(0,m.mdx)("inlineCode",{parentName:"p"},"GET")," queries. ",(0,m.mdx)("inlineCode",{parentName:"p"},"POST")," queries are not cached. To enforce this in your mesh, add the following configuration option:"),(0,m.mdx)("p",null,(0,m.mdx)("inlineCode",{parentName:"p"},'"useGETForQueries": true')),(0,m.mdx)(s,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,m.mdx)("p",null,"Use the ",(0,m.mdx)("a",{parentName:"p",href:"https://developer.fastly.com/reference/http/http-headers/Fastly-Debug/"},(0,m.mdx)("inlineCode",{parentName:"a"},"fastly-debug:1"))," request header to get more information from Fastly on each request. Adobe does not recommend using debug headers in production environments."),(0,m.mdx)("h3",{id:"fastly-example-mesh"},"Fastly example mesh"),(0,m.mdx)("p",null,"The following example mesh specifies the headers to cache, enables the cache bypass, and sets all queries to pass as ",(0,m.mdx)("inlineCode",{parentName:"p"},"GET")," queries."),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-json"},'{\n  "meshConfig": {\n    "responseConfig": {\n      "includeHTTPDetails": true\n    },\n    "sources": [\n      {\n        "name": "Core",\n        "handler": {\n          "graphql": {\n            "endpoint": "https://venia.magento.com/graphql",\n            "operationHeaders": {\n              "x-magento-cache-id": "{context.headers[\'x-magentocache-id\']}",\n              "Store": "{context.headers[\'store\']}" ,\n              "Authorization": "{context.headers[\'authorization\']}",\n              "Content-Type": "application/json",\n              "x-commerce-bypass-fastly-cache": "true"\n            },\n            "useGETForQueries": true\n          }\n        },\n        "responseConfig": {\n          "headers": [\n            "x-magento-cache-id",\n            "x-cache",\n            "x-magento-tags",\n            "set-cookie",\n            "pragma",\n            "cache-control",\n            "expires",\n            "x-content-type-options",\n            "x-xss-protection",\n            "x-platform-server"\n          ]\n        }\n      }\n    ]\n  }\n}\n')),(0,m.mdx)("h3",{id:"cache-header-prefixing"},"Cache header prefixing"),(0,m.mdx)("p",null,'API Mesh prefixes any Fastly source headers with their source name. For example, a source named "commerce" with an ',(0,m.mdx)("inlineCode",{parentName:"p"},"x-magento-cache-id")," header is converted to ",(0,m.mdx)("inlineCode",{parentName:"p"},"x-commerce-magento-cache-id"),'. However, if your endpoint URL contains "magento", API Mesh assumes you are connecting to an Adobe Commerce instance and does not prefix your headers with a source name. Using the previous example, your header would remain ',(0,m.mdx)("inlineCode",{parentName:"p"},"x-magento-cache-id"),"."),(0,m.mdx)("h3",{id:"test-your-mesh"},"Test your mesh"),(0,m.mdx)("p",null,"After you ",(0,m.mdx)("a",{parentName:"p",href:"./create-mesh.md#create-a-mesh"},"create")," or ",(0,m.mdx)("a",{parentName:"p",href:"./create-mesh.md#update-an-existing-mesh"},"update")," your mesh, run an ",(0,m.mdx)("a",{parentName:"p",href:"./command-reference.md#aio-api-meshdescribe"},(0,m.mdx)("inlineCode",{parentName:"a"},"aio api-mesh:describe"))," command to view your mesh URL. Run a query against this URL to confirm that your mesh is working correctly."),(0,m.mdx)("h2",{id:"configure-fastly-in-adobe-commerce"},"Configure Fastly in Adobe Commerce"),(0,m.mdx)("p",null,"After setting up your API Mesh, open your Adobe Commerce Admin and use the following steps to configure dynamic content caching with the provided Fastly CDN. You will need access to the following prerequisites:"),(0,m.mdx)("ul",null,(0,m.mdx)("li",{parentName:"ul"},"Adobe Commerce",(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},"Admin access"))),(0,m.mdx)("li",{parentName:"ul"},"API Mesh",(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},"The ability to create or update a mesh")))),(0,m.mdx)("ol",null,(0,m.mdx)("li",{parentName:"ol"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("a",{parentName:"p",href:"https://experienceleague.adobe.com/docs/commerce-cloud-service/user-guide/cdn/setup-fastly/fastly-configuration.html?lang=en#get-fastly-credentials"},"Get the following Fastly credentials"),":"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},"Fastly Service ID"),(0,m.mdx)("li",{parentName:"ul"},"Fastly API Token"))),(0,m.mdx)("li",{parentName:"ol"},(0,m.mdx)("p",{parentName:"li"},"In the Adobe Commerce Admin, select ",(0,m.mdx)("strong",{parentName:"p"},"Store")," > Settings > ",(0,m.mdx)("strong",{parentName:"p"},"Configuration")," > ",(0,m.mdx)("strong",{parentName:"p"},"Advanced")," > ",(0,m.mdx)("strong",{parentName:"p"},"System")," > ",(0,m.mdx)("strong",{parentName:"p"},"Full Page Cache")," and set the ",(0,m.mdx)("strong",{parentName:"p"},"Caching Application")," field to ",(0,m.mdx)("strong",{parentName:"p"},"Fastly CDN"),".")),(0,m.mdx)("li",{parentName:"ol"},(0,m.mdx)("p",{parentName:"li"},"Enter the Fastly credentials you retrieved previously into the ",(0,m.mdx)("strong",{parentName:"p"},"Fastly Service ID")," and ",(0,m.mdx)("strong",{parentName:"p"},"Fastly API Token")," fields. Then click the ",(0,m.mdx)("strong",{parentName:"p"},"Test Credentials")," button to verify that your credentials are correct."),(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("span",{parentName:"p",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1280px"}},"\n      ",(0,m.mdx)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"48.12500000000001%",position:"relative",bottom:"0",left:"0",display:"block",transition:"opacity 0.5s 0.5s",pointerEvents:"none"}}),"\n  ",(0,m.mdx)("picture",{parentName:"span"},"\n          ",(0,m.mdx)("source",{parentName:"picture",srcSet:["/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/5530d/fastly-credentials.webp 320w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/0c8fb/fastly-credentials.webp 640w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/94b1e/fastly-credentials.webp 1280w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/0b34d/fastly-credentials.webp 1920w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/f15af/fastly-credentials.webp 2350w"],sizes:"(max-width: 1280px) 100vw, 1280px",type:"image/webp"}),"\n          ",(0,m.mdx)("source",{parentName:"picture",srcSet:["/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/dd4a7/fastly-credentials.png 320w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/0f09e/fastly-credentials.png 640w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/bbbf7/fastly-credentials.png 1280w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/ac7a9/fastly-credentials.png 1920w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/f9feb/fastly-credentials.png 2350w"],sizes:"(max-width: 1280px) 100vw, 1280px",type:"image/png"}),"\n          ",(0,m.mdx)("img",{parentName:"picture",className:"gatsby-resp-image-image",src:"/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/bbbf7/fastly-credentials.png",alt:"fastly-credentials",title:"fastly-credentials",loading:"lazy",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",opacity:"0",transition:"opacity 0.5s",color:"inherit",boxShadow:"inset 0px 0px 0px 400px none",top:"0",left:"0"}}),"\n        "),"\n    "))),(0,m.mdx)("li",{parentName:"ol"},(0,m.mdx)("p",{parentName:"li"},"Under ",(0,m.mdx)("strong",{parentName:"p"},"Fastly Configuration")," > ",(0,m.mdx)("strong",{parentName:"p"},"Custom VCL Snippets")," click ",(0,m.mdx)("strong",{parentName:"p"},"Create")," and add the following ",(0,m.mdx)("a",{parentName:"p",href:"https://experienceleague.adobe.com/docs/commerce-cloud-service/user-guide/cdn/custom-vcl-snippets/fastly-vcl-custom-snippets.html"},"snippets"),". For more information on VCL subroutines, see ",(0,m.mdx)("a",{parentName:"p",href:"https://developer.fastly.com/reference/vcl/subroutines/"},"Custom Subroutines"),"."),(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"NOTE"),": The ",(0,m.mdx)("inlineCode",{parentName:"p"},"Priority")," of each VCL snippet determines the order in which VCL subroutines are executed. The following ",(0,m.mdx)("inlineCode",{parentName:"p"},"Priority")," fields only apply to the default configuration of Adobe Commerce. If you have other custom snippets, you will need to adjust the priorities accordingly."),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},"Allows API Mesh to function as a ",(0,m.mdx)("a",{parentName:"p",href:"https://developer.fastly.com/reference/vcl/declarations/backend/"},"Fastly backend"),":"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - api_mesh_backend")),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Type")," - ",(0,m.mdx)("strong",{parentName:"p"},"init"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"p"},"1"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Content"),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'backend F_graph_prod_adobe_io {\n    .always_use_host_header = true;\n    .between_bytes_timeout = 10s;\n    .connect_timeout = 1s;\n    .dynamic = true;\n    .first_byte_timeout = 15s;\n    .host = "graph.adobe.io";\n    .host_header = "graph.adobe.io";\n    .max_connections = 200;\n    .port = "443";\n    .share_key = "XXXXXXXXXXXXXXXX";\n    .ssl = true;\n    .ssl_cert_hostname = "graph.adobe.io";\n    .ssl_check_cert = always;\n    .ssl_sni_hostname = "graph.adobe.io";\n    .probe = {\n        .dummy = true;\n        .initial = 5;\n        .request = "HEAD / HTTP/1.1" "Host: graph.adobe.io" "Connection: close";\n        .threshold = 1;\n        .timeout = 2s;\n        .window = 5;\n    }\n}\n'))))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},"Enables the bypass header in API Mesh:"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - api_mesh_recv")),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Type")," - ",(0,m.mdx)("strong",{parentName:"p"},"recv"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"p"},"10"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Content"),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'if (req.http.x - commerce - bypass - fastly - cache == "true") {\n  return (pass);\n}\n'))))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},"Determines what GraphQL can be cached:"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - api_mesh_recv2")),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Type")," - ",(0,m.mdx)("strong",{parentName:"p"},"recv"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"p"},"60"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Content"),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'if ((req.request == "GET" || req.request == "HEAD") && (req.url.path~"/graphql" || req.url "^/api/(.*)") && req.url.qs~"query=") {\n  set req.http.graphql = "1";\n}\nelse {\n  unset req.http.graphql;\n}\nif (req.url.path!~"/graphql" && req.url!~"^/api/(.*)") {\n  set req.http.Magento - Original - URL = req.url;\n\n  set req.url = querystring.regfilter(req.url, "^(utm_.*|gclid|gdftrk|_ga|mc_.*|trk_.*|dm_i|_ke|sc_.*|fbclid)$");\n}\n'))))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},"Cache miss - replace the ",(0,m.mdx)("inlineCode",{parentName:"p"},"<mesh_id>")," and ",(0,m.mdx)("inlineCode",{parentName:"p"},"<mesh_api_key>")," placeholders with the information from your API Mesh URL, which has the following structure: ",(0,m.mdx)("inlineCode",{parentName:"p"},"https://graph.adobe.io/api/<meshId>/graphql?api_key=<your_apiKey>"),". You can retrieve this information by running an ",(0,m.mdx)("a",{parentName:"p",href:"./command-reference.md#aio-api-meshdescribe"},(0,m.mdx)("inlineCode",{parentName:"a"},"aio api-mesh:describe"))," command:"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - api_mesh_miss")),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Type")," - ",(0,m.mdx)("strong",{parentName:"p"},"miss"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"p"},"60"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Content"),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'if (req.url~"^/api/") {\n  set req.backend = F_graph_prod_adobe_io;\n}\n//API Mesh prod mapping\nif (req.url~"^/api/<mesh_id>") {\n  set bereq.http.x - api - key = "<mesh_api_key>";\n}\n# //Optionally add another mesh\n# //API Mesh stage mapping\n# if (req.url~"^/api/<mesh_id>") {\n#   set bereq.http.x - api - key = "<mesh_api_key>";\n# }\n')))))),(0,m.mdx)("p",{parentName:"li"},"The following ",(0,m.mdx)("inlineCode",{parentName:"p"},"api_mesh_pass")," snippet allows you to query your mesh URL without appending the ",(0,m.mdx)("inlineCode",{parentName:"p"},"api_key"),":"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},"Cache pass - replace the ",(0,m.mdx)("inlineCode",{parentName:"p"},"<mesh_id>")," and ",(0,m.mdx)("inlineCode",{parentName:"p"},"<mesh_api_key>")," placeholders with the information from your mesh URL, which has the following structure: ",(0,m.mdx)("inlineCode",{parentName:"p"},"https://graph.adobe.io/api/<meshId>/graphql?api_key=<mesh_api_key>"),":"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - api_mesh_pass")),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Type")," - ",(0,m.mdx)("strong",{parentName:"p"},"pass"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"p"},"10"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Content"),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'if (req.url ~ "^/api/") {\n  set req.backend = F_graph_prod_adobe_io;\n}\n//API Mesh prod mapping\nif (req.url ~ "^/api/<mesh_id>") {\n  set bereq.http.x-api-key = "<mesh_api_key>";\n}\n# //Optionally add another environment\n# //API Mesh stage mapping\n# if (req.url ~ "^/api/<mesh_id>") {\n#   set bereq.http.x-api-key = "<mesh_api_key>";\n# }\n'))))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},"Cache fetch:"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - api_mesh_fetch")),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Type")," - ",(0,m.mdx)("strong",{parentName:"p"},"fetch"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"p"},"10"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Content"),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'if (req.http.x - commerce - bypass - fastly - cache == "true") {\n  return (pass);\n}\n'))))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},"Cache deliver:"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - api_mesh_deliver")),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Type")," - ",(0,m.mdx)("strong",{parentName:"p"},"deliver"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"p"},"10"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Content"),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'if (req.http.x - commerce - bypass - fastly - cache == "true") {\n  return (deliver);\n}\n'))))))),(0,m.mdx)("li",{parentName:"ol"},(0,m.mdx)("p",{parentName:"li"},"In ",(0,m.mdx)("strong",{parentName:"p"},"Fastly Configuration")," > ",(0,m.mdx)("strong",{parentName:"p"},"Backend Settings")," click ",(0,m.mdx)("strong",{parentName:"p"},"Create"),". Add a new backend with the following information:"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("strong",{parentName:"li"},"Condition")," - ",(0,m.mdx)("inlineCode",{parentName:"li"},'req.url ~ "^/api/(.*)" ,')),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("strong",{parentName:"li"},"Address")," - ",(0,m.mdx)("strong",{parentName:"li"},"graph.adobe.io")),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("strong",{parentName:"li"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"li"},"8")))),(0,m.mdx)("li",{parentName:"ol"},(0,m.mdx)("p",{parentName:"li"},"In ",(0,m.mdx)("strong",{parentName:"p"},"Fastly Configuration")," click ",(0,m.mdx)("strong",{parentName:"p"},"Upload VCL to Fastly"),". Click ",(0,m.mdx)("strong",{parentName:"p"},"Save Config"),"."))),(0,m.mdx)("h2",{id:"test-your-configuration"},"Test your configuration"),(0,m.mdx)("p",null,"Run the following cURL command, replacing ",(0,m.mdx)("inlineCode",{parentName:"p"},"<Commerce-URL>")," with your Adobe Commerce storefront URL."),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-bash"},"curl --globoff --include '<Commerce-URL>/graphql?query={products(search%3A%20%22c%22){items{sku}}}' --header 'Fastly-Debug: 1' -w \"\\n\\ntime_starttransfer: %{time_starttransfer}\\n\"\n")),(0,m.mdx)("p",null,"Review the values of the ",(0,m.mdx)("inlineCode",{parentName:"p"},"x-cache")," and ",(0,m.mdx)("inlineCode",{parentName:"p"},"x-cache-hits")," headers to determine if the cache is being used. The first time you run this query, the headers should return:"),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-yaml"},"x-cache: MISS, MISS\nx-cache-hits: 0\n")),(0,m.mdx)("p",null,"Two ",(0,m.mdx)("inlineCode",{parentName:"p"},"MISS")," values and ",(0,m.mdx)("inlineCode",{parentName:"p"},"0")," hits indicate that the cache was not used in this query. Run the cURL command again and you should see the values change to the following:"),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-yaml"},"x-cache: MISS, HIT\nx-cache-hits: 1 \n")),(0,m.mdx)("p",null,"A value of ",(0,m.mdx)("inlineCode",{parentName:"p"},"MISS, HIT")," and ",(0,m.mdx)("inlineCode",{parentName:"p"},"1")," or more hits indicates that the cache is in use. You can also verify cache usage by comparing cached and uncached response times."))}h.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-gateway-fastly-md-d7904dd9fd7e45b485f1.js.map