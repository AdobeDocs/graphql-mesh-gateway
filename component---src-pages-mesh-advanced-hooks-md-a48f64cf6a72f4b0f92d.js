"use strict";(self.webpackChunkgraphql_mesh_gateway=self.webpackChunkgraphql_mesh_gateway||[]).push([[9788],{3348:function(e,n,o){o.r(n),o.d(n,{_frontmatter:function(){return m},default:function(){return c}});var a=o(58168),t=o(80045),r=(o(88763),o(15680)),l=o(83407);const s=["components"],m={},i=(d="InlineAlert",function(e){return console.warn("Component "+d+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.mdx)("div",e)});var d;const p={_frontmatter:m},u=l.A;function c(e){let{components:n}=e,o=(0,t.A)(e,s);return(0,r.mdx)(u,(0,a.A)({},p,o,{components:n,mdxType:"MDXLayout"}),(0,r.mdx)("h1",{id:"hooks"},"Hooks"),(0,r.mdx)(i,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,r.mdx)("p",null,"The hooks feature is currently in development and will be expanded in future releases. Only ",(0,r.mdx)("inlineCode",{parentName:"p"},"beforeAll")," hooks are currently available."),(0,r.mdx)(i,{variant:"warning",slots:"text",mdxType:"InlineAlert"}),(0,r.mdx)("p",null,"Edge meshes do not currently support Hooks. If you are using hooks, you must use a legacy mesh. Hooks will be available in edge meshes in the future."),(0,r.mdx)("p",null,"Hooks allow you to invoke a composable ",(0,r.mdx)("a",{parentName:"p",href:"#local-vs-remote-functions"},"local or remote")," function on a targeted node."),(0,r.mdx)("p",null,"Some use cases for the ",(0,r.mdx)("inlineCode",{parentName:"p"},"Hooks")," include:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"Authenticating a user before all operations")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"Checking for an authorization token before making a request"))),(0,r.mdx)(i,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,r.mdx)("p",null,"You cannot use hooks to modify the request or the response. If you want to manipulate data, we recommend that you use ",(0,r.mdx)("a",{parentName:"p",href:"./extending-unified-schema.md"},"custom resolvers"),"."),(0,r.mdx)("p",null,"Hooks increase processing time. Use them sparingly if processing time is important. Hooks are executed in the order you provide them. However, any ",(0,r.mdx)("inlineCode",{parentName:"p"},"blocking")," hooks execute before non-blocking hooks."),(0,r.mdx)("h2",{id:"hook-arguments"},"Hook arguments"),(0,r.mdx)("p",null,"Hooks are plugins that accept the following arguments:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-json"},'"hooks": {\n    "beforeAll": {\n        "composer": "<Local or Remote file>",\n        "blocking": true|false\n    }\n}\n')),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},(0,r.mdx)("inlineCode",{parentName:"p"},"composer")," (string) - The local or remote file location of the function you want to execute."),(0,r.mdx)("p",{parentName:"li"},"  You must add any local scripts to the mesh's ",(0,r.mdx)("a",{parentName:"p",href:"../basic/handlers/index.md#reference-local-files-in-handlers"},(0,r.mdx)("inlineCode",{parentName:"a"},"files")," array"),". ",(0,r.mdx)("a",{parentName:"p",href:"#local-vs-remote-functions"},"Local vs remote functions")," describes when to use a local or remote function."),(0,r.mdx)("p",{parentName:"li"},"  ",(0,r.mdx)("strong",{parentName:"p"},"NOTE"),": Local composer functions are limited to 30 seconds. If ",(0,r.mdx)("inlineCode",{parentName:"p"},"blocking")," is set to ",(0,r.mdx)("inlineCode",{parentName:"p"},"true")," and the function takes longer than 30 seconds, you will receive a ",(0,r.mdx)("inlineCode",{parentName:"p"},"Timeout Error"),". If you repeatedly encounter this error, consider using a ",(0,r.mdx)("a",{parentName:"p",href:"#local-vs-remote-functions"},"remote composer"),".")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},(0,r.mdx)("inlineCode",{parentName:"p"},"blocking")," (boolean) - (",(0,r.mdx)("inlineCode",{parentName:"p"},"false")," by default) Determines if the query waits for a successful return message before continuing the query."),(0,r.mdx)("p",{parentName:"li"},"  The ",(0,r.mdx)("inlineCode",{parentName:"p"},"blocking")," argument allows you to stop running hooks for a query that does not receive a successful response."),(0,r.mdx)("p",{parentName:"li"},"  If blocking is ",(0,r.mdx)("inlineCode",{parentName:"p"},"true")," and the composer returns an error, all future hook executions are canceled."),(0,r.mdx)("p",{parentName:"li"},"  If blocking is ",(0,r.mdx)("inlineCode",{parentName:"p"},"false")," and the composer returns an error, the composer will still be invoked."))),(0,r.mdx)("h2",{id:"types-of-hooks"},"Types of hooks"),(0,r.mdx)("h3",{id:"beforeall"},(0,r.mdx)("inlineCode",{parentName:"h3"},"beforeAll")),(0,r.mdx)("p",null,"The ",(0,r.mdx)("inlineCode",{parentName:"p"},"beforeAll")," hook allows you to insert a function before the query takes place. This is a good place to add an authentication layer or anything else you want to run before your query."),(0,r.mdx)(i,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,r.mdx)("p",null,"The ",(0,r.mdx)("inlineCode",{parentName:"p"},"beforeAll")," hook is a singular hook."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-json"},'"plugins": [\n    {\n        "hooks": {\n            "beforeAll": {\n                "composer": "./hooks.js#checkAuthHeader",\n                "blocking": true\n            }\n        }\n    }\n],\n')),(0,r.mdx)("h2",{id:"local-vs-remote-functions"},"Local vs remote functions"),(0,r.mdx)("p",null,(0,r.mdx)("inlineCode",{parentName:"p"},"local")," composers are defined within your ",(0,r.mdx)("inlineCode",{parentName:"p"},"mesh.json")," file, whereas ",(0,r.mdx)("inlineCode",{parentName:"p"},"remote")," composers are only referenced within your mesh file. Local and remote composers have different advantages and limitations."),(0,r.mdx)("h3",{id:"local-composers"},(0,r.mdx)("inlineCode",{parentName:"h3"},"local")," composers"),(0,r.mdx)("p",null,"Use local composers if:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"The entire operation will take less than 30 seconds.")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"The composer logic is simple and only requires access to the headers, body, and other context objects."))),(0,r.mdx)("p",null,"Avoid using local composers if:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"The entire operation will take more than 30 seconds.")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"The composer needs to make network calls.")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"The composer has complex or nested loops.")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"The composer uses restricted constructs, such as ",(0,r.mdx)("inlineCode",{parentName:"p"},"setTimeout"),", ",(0,r.mdx)("inlineCode",{parentName:"p"},"setInterval"),", ",(0,r.mdx)("inlineCode",{parentName:"p"},"for"),", ",(0,r.mdx)("inlineCode",{parentName:"p"},"while"),", ",(0,r.mdx)("inlineCode",{parentName:"p"},"console"),", ",(0,r.mdx)("inlineCode",{parentName:"p"},"process"),", ",(0,r.mdx)("inlineCode",{parentName:"p"},"global"),", or ",(0,r.mdx)("inlineCode",{parentName:"p"},"throw"),"."))),(0,r.mdx)("p",null,"Local composers require adding any local scripts to the mesh's ",(0,r.mdx)("a",{parentName:"p",href:"../basic/handlers/index.md#reference-local-files-in-handlers"},(0,r.mdx)("inlineCode",{parentName:"a"},"files")," array"),"."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-json"},'{\n  "meshConfig": {\n    "sources": [\n      {\n        "name": "MagentoMonolithApi",\n        "handler": {\n          "graphql": {\n            "endpoint": "https://venia.magento.com/graphql"\n          }\n        }\n      }\n    ],\n    "plugins": [\n      {\n        "hooks": {\n          "beforeAll": {\n            "composer": "./hooks.js#checkAuthHeader",\n            "blocking": true\n          }\n        }\n      }\n    ],\n    "files": [\n      {\n        "path": "./hooks.js",\n        "content": <FILE CONTENT>\n      }\n    ]\n  }\n}\n')),(0,r.mdx)("h3",{id:"remote-composers"},(0,r.mdx)("inlineCode",{parentName:"h3"},"remote")," composers"),(0,r.mdx)("p",null,"If a local composer does not work or causes timeout errors, consider using a remote composer."),(0,r.mdx)(i,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,r.mdx)("p",null,"When using ",(0,r.mdx)("inlineCode",{parentName:"p"},"remote")," composers, you could see decreased performance, because ",(0,r.mdx)("inlineCode",{parentName:"p"},"remote")," composers add a network hop."),(0,r.mdx)("p",null,(0,r.mdx)("inlineCode",{parentName:"p"},"remote")," composers can use the ",(0,r.mdx)("inlineCode",{parentName:"p"},"params"),", ",(0,r.mdx)("inlineCode",{parentName:"p"},"context"),", and ",(0,r.mdx)("inlineCode",{parentName:"p"},"document")," arguments over the network. However, the serialization and deserialization of JSON data means that any complex fields or references will be lost. If the composer depends on complex fields or references, consider using a ",(0,r.mdx)("inlineCode",{parentName:"p"},"local")," composer instead."),(0,r.mdx)("h3",{id:"example"},"Example"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-json"},'{\n  "meshConfig": {\n    "sources": [\n      {\n        "name": "MagentoMonolithApi",\n        "handler": {\n          "graphql": {\n            "endpoint": "https://venia.magento.com/graphql"\n          }\n        }\n      }\n    ],\n    "plugins": [\n      {\n        "hooks": {\n          "beforeAll": {\n            "composer": "<Remote Composer URL>",\n            "blocking": true\n          }\n        }\n      }\n    ]\n  }\n}\n')),(0,r.mdx)("h2",{id:"creating-composers"},"Creating ",(0,r.mdx)("inlineCode",{parentName:"h2"},"composers")),(0,r.mdx)("p",null,"A composer can be a local function or a remote serverless function. Composer signatures differ depending on the hook used and the location of the function."),(0,r.mdx)("h3",{id:"beforeall-hooks"},(0,r.mdx)("inlineCode",{parentName:"h3"},"beforeAll")," hooks"),(0,r.mdx)("p",null,(0,r.mdx)("inlineCode",{parentName:"p"},"beforeAll")," hooks can receive the following fields as objects during runtime:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},(0,r.mdx)("inlineCode",{parentName:"p"},"context")," - An object containing information about the request."),(0,r.mdx)("p",{parentName:"li"},"  For example, ",(0,r.mdx)("inlineCode",{parentName:"p"},"context")," can contain ",(0,r.mdx)("inlineCode",{parentName:"p"},"headers"),", the ",(0,r.mdx)("inlineCode",{parentName:"p"},"body")," of the request, and the request ",(0,r.mdx)("inlineCode",{parentName:"p"},"object"),".")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},(0,r.mdx)("inlineCode",{parentName:"p"},"document")," - A GraphQL representation of the query."))),(0,r.mdx)(i,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,r.mdx)("p",null,"Since the ",(0,r.mdx)("inlineCode",{parentName:"p"},"beforeAll")," hook runs at the root level, the ",(0,r.mdx)("inlineCode",{parentName:"p"},"document")," object is empty (",(0,r.mdx)("inlineCode",{parentName:"p"},"{}"),") by default."),(0,r.mdx)("p",null,"If the ",(0,r.mdx)("inlineCode",{parentName:"p"},"composer")," is a remote function, all the arguments are sent in the ",(0,r.mdx)("inlineCode",{parentName:"p"},"POST")," body when calling the function."),(0,r.mdx)(i,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,r.mdx)("p",null,"Due to the limitations of ",(0,r.mdx)("inlineCode",{parentName:"p"},"JSON")," serialization and de-serialization, some complex ",(0,r.mdx)("inlineCode",{parentName:"p"},"JSON")," fields inside a remote function's arguments might not function correctly over the ",(0,r.mdx)("inlineCode",{parentName:"p"},"HTTPS")," call."),(0,r.mdx)("h4",{id:"local-composer-example"},"Local composer example"),(0,r.mdx)("p",null,"This simple composer checks for an authorization header before processing the query."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-js"},'module.exports = {\n  isAuth: ({context}) => {\n    if (!context.headers.authorization) {\n      return {\n        status: "ERROR",\n        message: "Unauthorized",\n      };\n    }\n    return {\n      status: "SUCCESS",\n      message: "Authorized",\n    };\n  },\n};\n')),(0,r.mdx)("p",null,"This remote composer fetches your authorization token and inserts it into the ",(0,r.mdx)("inlineCode",{parentName:"p"},"x-auth-token")," header."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-js"},'function getToken({ authorization = "", body = "", url = "" }) {\n  return `${authorization} - ${body} - ${url}`;\n}\n\nmodule.exports = {\n  insertToken: ({ context }) => {\n    const { headers, request, body } = context;\n    const { authorization } = headers;\n    const { url } = request;\n\n    const authToken = getToken({ authorization, url, body });\n\n    return {\n      status: "SUCCESS",\n      message: "Authorized",\n      data: {\n        headers: {\n          "x-auth-token": authToken,\n        },\n      },\n    };\n  },\n};\n')),(0,r.mdx)("h4",{id:"remote-composer-example"},"Remote composer example"),(0,r.mdx)("p",null,"The following example remote composer checks for an ",(0,r.mdx)("inlineCode",{parentName:"p"},"authorization")," header."),(0,r.mdx)(i,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,r.mdx)("p",null,"While this example uses Fastly Edge computing, you can use any serverless function with remote hooks."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-js"},'addEventListener("fetch", (event) => event.respondWith(handleRequest(event)));\n\nasync function handleRequest(event) {\n    try {\n        const body = await event.request.json();\n        if (!body.context.headers["authorization"]) {\n            return new Response({\n                status: "SUCCESS",\n                message: "Unauthorized"\n            }, {\n                status: 401\n            });\n        }\n        return new Response({\n            status: "SUCCESS",\n            message: "Authorized"\n        }, {\n            status: 200\n        });\n    } catch (err) {\n        return new Response(err, {\n            status: 500\n        });\n    }\n}\n')),(0,r.mdx)("h3",{id:"return-signatures"},"Return signatures"),(0,r.mdx)("p",null,"The return signature of a composer is the same for local and remote functions."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-ts"},'{\n  status: "ERROR" | "SUCCESS",\n  message: string,\n  data?: {\n    headers?: {\n        [headerName: string]: string\n    }\n  }\n}\n')))}c.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-mesh-advanced-hooks-md-a48f64cf6a72f4b0f92d.js.map