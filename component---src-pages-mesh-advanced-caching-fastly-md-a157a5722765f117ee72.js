"use strict";(self.webpackChunkgraphql_mesh_gateway=self.webpackChunkgraphql_mesh_gateway||[]).push([[205],{19349:function(e,a,n){n.r(a),n.d(a,{_frontmatter:function(){return d},default:function(){return x}});var t=n(58168),r=n(80045),m=(n(88763),n(15680)),p=n(83407);const i=["components"],d={},s=(o="InlineAlert",function(e){return console.warn("Component "+o+" was not imported, exported, or provided by MDXProvider as global scope"),(0,m.mdx)("div",e)});var o;const l={_frontmatter:d},c=p.A;function x(e){let{components:a}=e,n=(0,r.A)(e,i);return(0,m.mdx)(c,(0,t.A)({},l,n,{components:a,mdxType:"MDXLayout"}),(0,m.mdx)("h1",{id:"dynamic-cache-control-with-fastly"},"Dynamic cache control with Fastly"),(0,m.mdx)("p",null,"Adding a content delivery network (CDN) for caching dynamic content with API Mesh for Adobe Developer App Builder provides additional security and improved performance. Follow these instructions to integrate API Mesh, Adobe Commerce, and ",(0,m.mdx)("a",{parentName:"p",href:"https://experienceleague.adobe.com/docs/commerce-cloud-service/user-guide/cdn/fastly.html?lang=en"},"Fastly")," (provided with Adobe Commerce Pro accounts)."),(0,m.mdx)("h2",{id:"configure-headers-in-api-mesh"},"Configure headers in API Mesh"),(0,m.mdx)(s,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,m.mdx)("p",null,"After adding VCL snippets in the ",(0,m.mdx)("a",{parentName:"p",href:"#configure-fastly-in-adobe-commerce"},"Fastly Setup"),", your Commerce GraphQL URL is now in the following format: ",(0,m.mdx)("inlineCode",{parentName:"p"},"<Commerce-URL>/api/<meshId>/graphql")),(0,m.mdx)("p",null,"To distinguish between requests from users and requests from API Mesh, use the following source operation header to prevent Fastly from caching headers that come directly from API Mesh:"),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-json"},'"x-commerce-bypass-fastly-cache": "true" \n')),(0,m.mdx)("p",null,"When bypassing the cache, you must also specify which headers should be preserved in the ",(0,m.mdx)("inlineCode",{parentName:"p"},"responseConfig"),":"),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-json"},'"responseConfig": {\n  "headers": [\n    "x-magento-cache-id",\n    "x-magento-tags",\n    "set-cookie",\n    "pragma",\n    "cache-control",\n    "expires",\n    "x-content-type-options",\n    "x-xss-protection",\n    "x-platform-server"\n  ]\n}\n')),(0,m.mdx)("p",null,"Using Fastly also requires all queries to be ",(0,m.mdx)("inlineCode",{parentName:"p"},"GET")," queries. ",(0,m.mdx)("inlineCode",{parentName:"p"},"POST")," queries are not cached. To enforce this in your mesh, add the following configuration option:"),(0,m.mdx)("p",null,(0,m.mdx)("inlineCode",{parentName:"p"},'"useGETForQueries": true')),(0,m.mdx)(s,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,m.mdx)("p",null,"Use the ",(0,m.mdx)("a",{parentName:"p",href:"https://developer.fastly.com/reference/http/http-headers/Fastly-Debug/"},(0,m.mdx)("inlineCode",{parentName:"a"},"fastly-debug:1"))," request header to get more information from Fastly on each request. Adobe does not recommend using debug headers in production environments."),(0,m.mdx)("h3",{id:"fastly-example-mesh"},"Fastly example mesh"),(0,m.mdx)("p",null,"The following example mesh specifies the headers to cache, enables the cache bypass, and sets all queries to pass as ",(0,m.mdx)("inlineCode",{parentName:"p"},"GET")," queries."),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-json"},'{\n  "meshConfig": {\n    "responseConfig": {\n      "includeHTTPDetails": true\n    },\n    "sources": [\n      {\n        "name": "Core",\n        "handler": {\n          "graphql": {\n            "endpoint": "https://venia.magento.com/graphql",\n            "operationHeaders": {\n              "x-magento-cache-id": "{context.headers[\'x-magento-cache-id\']}",\n              "Store": "{context.headers[\'store\']}" ,\n              "Authorization": "{context.headers[\'authorization\']}",\n              "Content-Type": "application/json",\n              "x-commerce-bypass-fastly-cache": "true"\n            },\n            "useGETForQueries": true\n          }\n        },\n        "responseConfig": {\n          "headers": [\n            "x-magento-cache-id",\n            "x-cache",\n            "x-magento-tags",\n            "set-cookie",\n            "pragma",\n            "cache-control",\n            "expires",\n            "x-content-type-options",\n            "x-xss-protection",\n            "x-platform-server"\n          ]\n        }\n      }\n    ]\n  }\n}\n')),(0,m.mdx)("h3",{id:"cache-header-prefixing"},"Cache header prefixing"),(0,m.mdx)("p",null,'API Mesh prefixes any Fastly source headers with their source name. For example, a source named "commerce" with an ',(0,m.mdx)("inlineCode",{parentName:"p"},"x-magento-cache-id")," header is converted to ",(0,m.mdx)("inlineCode",{parentName:"p"},"x-commerce-magento-cache-id"),'. However, if your endpoint URL contains "magento", API Mesh assumes you are connecting to an Adobe Commerce instance and does not prefix your headers with a source name. Using the previous example, your header would remain ',(0,m.mdx)("inlineCode",{parentName:"p"},"x-magento-cache-id"),"."),(0,m.mdx)("h3",{id:"test-your-mesh"},"Test your mesh"),(0,m.mdx)("p",null,"After you ",(0,m.mdx)("a",{parentName:"p",href:"../../basic/create-mesh.md#create-a-mesh"},"create")," or ",(0,m.mdx)("a",{parentName:"p",href:"../../basic/create-mesh.md#update-an-existing-mesh"},"update")," your mesh, run an ",(0,m.mdx)("a",{parentName:"p",href:"../../advanced/index.md#aio-api-meshdescribe"},(0,m.mdx)("inlineCode",{parentName:"a"},"aio api-mesh:describe"))," command to view your mesh URL. Run a query against this URL to confirm that your mesh is working correctly."),(0,m.mdx)("h2",{id:"configure-fastly-in-adobe-commerce"},"Configure Fastly in Adobe Commerce"),(0,m.mdx)("p",null,"The following sections describe how to configure Fastly in Adobe Commerce."),(0,m.mdx)("h3",{id:"add-vcl-snippets"},"Add VCL snippets"),(0,m.mdx)("p",null,"After setting up your API Mesh, open your Adobe Commerce Admin and use the following steps to configure dynamic content caching with the provided Fastly CDN. You will need access to the following prerequisites:"),(0,m.mdx)("ul",null,(0,m.mdx)("li",{parentName:"ul"},"Adobe Commerce",(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},"Admin access"))),(0,m.mdx)("li",{parentName:"ul"},"API Mesh",(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},"The ability to create or update a mesh")))),(0,m.mdx)("ol",null,(0,m.mdx)("li",{parentName:"ol"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("a",{parentName:"p",href:"https://experienceleague.adobe.com/docs/commerce-cloud-service/user-guide/cdn/setup-fastly/fastly-configuration.html?lang=en#get-fastly-credentials"},"Get the following Fastly credentials"),":"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},"Fastly Service ID"),(0,m.mdx)("li",{parentName:"ul"},"Fastly API Token"))),(0,m.mdx)("li",{parentName:"ol"},(0,m.mdx)("p",{parentName:"li"},"In the Adobe Commerce Admin, select ",(0,m.mdx)("strong",{parentName:"p"},"Store")," > Settings > ",(0,m.mdx)("strong",{parentName:"p"},"Configuration")," > ",(0,m.mdx)("strong",{parentName:"p"},"Advanced")," > ",(0,m.mdx)("strong",{parentName:"p"},"System")," > ",(0,m.mdx)("strong",{parentName:"p"},"Full Page Cache")," and set the ",(0,m.mdx)("strong",{parentName:"p"},"Caching Application")," field to ",(0,m.mdx)("strong",{parentName:"p"},"Fastly CDN"),".")),(0,m.mdx)("li",{parentName:"ol"},(0,m.mdx)("p",{parentName:"li"},"Enter the Fastly credentials you retrieved previously into the ",(0,m.mdx)("strong",{parentName:"p"},"Fastly Service ID")," and ",(0,m.mdx)("strong",{parentName:"p"},"Fastly API Token")," fields. Then click the ",(0,m.mdx)("strong",{parentName:"p"},"Test Credentials")," button to verify that your credentials are correct."),(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("span",{parentName:"p",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1280px"}},"\n      ",(0,m.mdx)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"48.12500000000001%",position:"relative",bottom:"0",left:"0",display:"block",transition:"opacity 0.5s 0.5s",pointerEvents:"none"}}),"\n  ",(0,m.mdx)("picture",{parentName:"span"},"\n          ",(0,m.mdx)("source",{parentName:"picture",srcSet:["/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/5530d/fastly-credentials.webp 320w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/0c8fb/fastly-credentials.webp 640w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/94b1e/fastly-credentials.webp 1280w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/0b34d/fastly-credentials.webp 1920w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/f15af/fastly-credentials.webp 2350w"],sizes:"(max-width: 1280px) 100vw, 1280px",type:"image/webp"}),"\n          ",(0,m.mdx)("source",{parentName:"picture",srcSet:["/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/dd4a7/fastly-credentials.png 320w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/0f09e/fastly-credentials.png 640w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/bbbf7/fastly-credentials.png 1280w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/ac7a9/fastly-credentials.png 1920w","/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/f9feb/fastly-credentials.png 2350w"],sizes:"(max-width: 1280px) 100vw, 1280px",type:"image/png"}),"\n          ",(0,m.mdx)("img",{parentName:"picture",className:"gatsby-resp-image-image",src:"/graphql-mesh-gateway/static/4db4bd2b0702749161300b6dad385ff3/bbbf7/fastly-credentials.png",alt:"fastly-credentials",title:"fastly-credentials",loading:"lazy",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",opacity:"0",transition:"opacity 0.5s",color:"inherit",boxShadow:"inset 0px 0px 0px 400px none",top:"0",left:"0"}}),"\n        "),"\n    "))),(0,m.mdx)("li",{parentName:"ol"},(0,m.mdx)("p",{parentName:"li"},"Under ",(0,m.mdx)("strong",{parentName:"p"},"Fastly Configuration")," > ",(0,m.mdx)("strong",{parentName:"p"},"Custom VCL Snippets")," click ",(0,m.mdx)("strong",{parentName:"p"},"Create")," and add the following ",(0,m.mdx)("a",{parentName:"p",href:"https://experienceleague.adobe.com/docs/commerce-cloud-service/user-guide/cdn/custom-vcl-snippets/fastly-vcl-custom-snippets.html"},"snippets"),". For more information on VCL subroutines, see ",(0,m.mdx)("a",{parentName:"p",href:"https://developer.fastly.com/reference/vcl/subroutines/"},"Custom Subroutines"),"."),(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"NOTE"),": The ",(0,m.mdx)("inlineCode",{parentName:"p"},"Priority")," of each VCL snippet determines the order in which VCL subroutines are executed. The following ",(0,m.mdx)("inlineCode",{parentName:"p"},"Priority")," fields only apply to the default configuration of Adobe Commerce. If you have other custom snippets, you will need to adjust the priorities accordingly."),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},"Allows API Mesh to function as a ",(0,m.mdx)("a",{parentName:"p",href:"https://developer.fastly.com/reference/vcl/declarations/backend/"},"Fastly backend"),"."),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - api_mesh_backend")),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Type")," - ",(0,m.mdx)("strong",{parentName:"p"},"init"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"p"},"1"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Content"),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'# Backend declaration\nbackend F_edge_graph_adobe_io {\n    .always_use_host_header = true;\n    .between_bytes_timeout = 30s;\n    .connect_timeout = 30s;\n    .dynamic = true;\n    .first_byte_timeout = 15s;\n    .host = "edge-graph.adobe.io";\n    .host_header = "edge-graph.adobe.io";\n    .keepalive_time = 25s;\n    .max_connections = 200;\n    .port = "443";\n    .share_key = "XXXXXXXXXXXXXXXX";\n    .ssl = true;\n    .ssl_cert_hostname = "edge-graph.adobe.io";\n    .ssl_check_cert = always;\n    .ssl_sni_hostname = "edge-graph.adobe.io";\n    .max_tls_version = "1.3";\n    .min_tls_version = "1.3";\n    .probe = {\n        .dummy = true;\n        .initial = 5;\n        .request = "HEAD / HTTP/1.1" "Host: edge-graph.adobe.io" "Connection: close";\n        .threshold = 1;\n        .timeout = 2s;\n        .window = 5;\n    }\n}\n'))))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},"Enables the bypass header in API Mesh:"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - api_mesh_recv")),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Type")," - ",(0,m.mdx)("strong",{parentName:"p"},"recv"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"p"},"10"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Content"),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'# set mesh backend for /api/ requests\nif (req.url ~ "^/api/") {\n  set req.backend = F_edge_graph_adobe_io;\n}\n\nif (req.http.x-commerce-bypass-fastly-cache == "true") {\n  return (pass);\n}\n\n# Determines what GraphQL can be cached\nif ((req.request == "GET" || req.request == "HEAD") && (req.url.path ~ "/graphql" || req.url ~ "^/api/(.*)") && req.url.qs ~ "query=") {\n  set req.http.graphql = "1";\n} else {\n  unset req.http.graphql;\n}\n\nif (req.url.path !~ "/graphql" && req.url !~ "^/api/(.*)") {\n  set req.http.Magento-Original-URL = req.url;\n  set req.url = querystring.regfilter(req.url, "^(utm_.*|gclid|gdftrk|_ga|mc_.*|trk_.*|dm_i|_ke|sc_.*|fbclid)$");\n}\n'))))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},"Cache fetch:"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - api_mesh_fetch")),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Type")," - ",(0,m.mdx)("strong",{parentName:"p"},"fetch"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"p"},"10"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Content"),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'if (req.http.x-commerce-bypass-fastly-cache == "true") {\n  return (pass);\n}\n'))))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},"Cache deliver:"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - api_mesh_deliver")),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Type")," - ",(0,m.mdx)("strong",{parentName:"p"},"deliver"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"p"},"10"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Content"),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'if (req.http.x-commerce-bypass-fastly-cache == "true") {\n  return (deliver);\n}\n'))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - keep-alive-vcl-miss"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Type")," - ",(0,m.mdx)("strong",{parentName:"p"},"miss"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"p"},"100"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Content"),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'set bereq.http.Connection = "keep-alive";\n'))))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - keep-alive-vcl-pass"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Type")," - ",(0,m.mdx)("strong",{parentName:"p"},"pass"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"p"},"100"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Content"),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'set bereq.http.Connection = "keep-alive";\n')))))))))),(0,m.mdx)("p",null,"In ",(0,m.mdx)("strong",{parentName:"p"},"Fastly Configuration")," click ",(0,m.mdx)("strong",{parentName:"p"},"Upload VCL to Fastly"),". Click ",(0,m.mdx)("strong",{parentName:"p"},"Save Config"),"."),(0,m.mdx)("h4",{id:"configure-fastly-next-gen-waf"},"Configure Fastly Next-Gen WAF"),(0,m.mdx)("p",null,"If you are using Adobe Commerce with Fastly Next-Gen WAF enabled, you must add the following VCL snippet, which prevents the WAF from inspecting the request twice. If you do not add this snippet, the Next-Gen WAF strips headers from the request, which can cause errors."),(0,m.mdx)("ul",null,(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - api_mesh_inspection")),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Type")," - ",(0,m.mdx)("strong",{parentName:"p"},"recv"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Priority")," - ",(0,m.mdx)("strong",{parentName:"p"},"1"))),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Content"),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'if (table.lookup(eds_domains, req.http.Host)  &&  req.url ~ "/graphql"){\n  set req.http.x-sigsci-no-inspection = "disabled";\n}\n')))),(0,m.mdx)("h3",{id:"configure-default-backend"},"Configure default backend"),(0,m.mdx)("p",null,'The default backend does not handle "/api/" requests. To allow API requests, add a condition to the existing backend:'),(0,m.mdx)("ol",null,(0,m.mdx)("li",{parentName:"ol"},(0,m.mdx)("p",{parentName:"li"},"In ",(0,m.mdx)("strong",{parentName:"p"},"Fastly Configuration > Backend Settings"),", click on the gear icon next to ",(0,m.mdx)("strong",{parentName:"p"},"<project_id>.magento.cloud"),".")),(0,m.mdx)("li",{parentName:"ol"},(0,m.mdx)("p",{parentName:"li"},"Click ",(0,m.mdx)("strong",{parentName:"p"},"Create a new request condition")," and add a condition like the following example:"),(0,m.mdx)("ul",{parentName:"li"},(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Name")," - default_backend")),(0,m.mdx)("li",{parentName:"ul"},(0,m.mdx)("p",{parentName:"li"},(0,m.mdx)("strong",{parentName:"p"},"Apply if..."),":"),(0,m.mdx)("pre",{parentName:"li"},(0,m.mdx)("code",{parentName:"pre",className:"language-csharp"},'req.url !~ "^/api/"\n'))))),(0,m.mdx)("li",{parentName:"ol"},(0,m.mdx)("p",{parentName:"li"},"Click ",(0,m.mdx)("strong",{parentName:"p"},"Create")," on the condition.")),(0,m.mdx)("li",{parentName:"ol"},(0,m.mdx)("p",{parentName:"li"},"Click ",(0,m.mdx)("strong",{parentName:"p"},"Create")," on the backend."))),(0,m.mdx)("h2",{id:"test-your-configuration"},"Test your configuration"),(0,m.mdx)("p",null,"Run the following cURL command, replacing ",(0,m.mdx)("inlineCode",{parentName:"p"},"<Commerce-URL>")," and ",(0,m.mdx)("inlineCode",{parentName:"p"},"<Magento-Cache-Id>")," with your Adobe Commerce storefront values."),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-bash"},"curl --globoff --include '<Commerce-URL>/api/<meshId>/graphql?query={products(search%3A%20%22c%22){items{sku}}}' --header 'x-magento-cache-id: <Magento-Cache-Id>' --header 'Fastly-Debug: 1' -w \"\\n\\ntime_starttransfer: %{time_starttransfer}\\n\"\n")),(0,m.mdx)("p",null,"Review the values of the ",(0,m.mdx)("inlineCode",{parentName:"p"},"x-cache")," and ",(0,m.mdx)("inlineCode",{parentName:"p"},"x-cache-hits")," headers to determine if the cache is being used. The first time you run this query, the headers should return:"),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-yaml"},"x-cache: MISS, MISS, MISS\nx-cache-hits: 0\n")),(0,m.mdx)("p",null,"Two ",(0,m.mdx)("inlineCode",{parentName:"p"},"MISS")," values and ",(0,m.mdx)("inlineCode",{parentName:"p"},"0")," hits indicate that the cache was not used in this query. Run the cURL command again and you should see the values change to the following:"),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-yaml"},"x-cache: MISS, HIT, MISS\nx-cache-hits: 1 \n")),(0,m.mdx)("p",null,"A value of ",(0,m.mdx)("inlineCode",{parentName:"p"},"MISS, HIT")," and ",(0,m.mdx)("inlineCode",{parentName:"p"},"1")," or more hits indicates that the cache is in use. You can also verify cache usage by comparing cached and uncached response times."))}x.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-mesh-advanced-caching-fastly-md-a157a5722765f117ee72.js.map